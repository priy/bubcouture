Element.extend({amongTo:function(f,e){var c=this;var a=c.getSize(),d=f.getSize();var b={width:2,height:2};if(e){b=$merge(b,e)}c.setStyles({position:"absolute"});var g={top:Math.abs(((d.size.y/b.height).toInt())-((a.size.y/b.height).toInt())+f.getPosition().y+d.scroll.y),left:Math.abs(((d.size.x/b.width).toInt())-((a.size.x/b.width).toInt())+f.getPosition().x+d.scroll.x)};c.setStyles(g);if(c.getStyle("opacity")<1){c.setOpacity(1)}if(c.getStyle("visibility")!="visible"){c.setStyle("visibility","visible")}if(c.getStyle("display")=="none"){c.setStyle("display","")}return this},zoomImg:function(b,h,d){if(this.getTag()!="img"||!this.width){return}var c={width:this.width,height:this.height};if(c.width>b){var g=c.width-b;var a=c.width-g;var e=(a/c.width).toFloat();var f=(c.height*e).toInt();$extend(c,{width:a,height:f})}if(c.height>h){var g=c.height-h;var f=c.height-g;var e=(f/c.height).toFloat();var a=(c.width*e).toInt();$extend(c,{width:a,height:f})}if(!d){return this.set(c)}return c},subText:function(b){var a=this.get("text");if(!b||a.length<=b){return a}this.setText(a.substring(0,b)+"...");if(!this.retrieve("tip:title")){this.set("title",a)}return a},getValues:function(){var a={};this.getFormElements().each(function(c){var b=c.name;var d=c.getValue();if(d===false||!b||c.disabled){return}a[c.name]=d});return a},getCis:function(){return this.getCoordinates(arguments[0])},getContainer:function(){return this.getParent("*[container='true']")||$("main")||document.body},bindValidator:function(j){j=j||"x-input";var a=true;var g=[];var d=this;var c=d.getElements("."+j);if(j!="_x_ipt"){c.combine(d.getElements("._x_ipt"))}if(!c||!c.length){return a}c.each(function(f,e){if(f.get("emptyText")){Element.clearEmptyText(f)}var k=validator.test(d,f);if(!k){g.push(e);a=false}});if(!a){var b=c[g[0]];try{if(b.isDisplay()){b.focus()}}catch(h){}}return a},show:function(){this.fireEvent("onshow",this);return $chk(this)?this.setStyle("display",""):this},hide:function(){this.fireEvent("onhide",this);return $chk(this)?this.setStyle("display","none"):this},isDisplay:function(){if("none"==this.getStyle("display")||(this.offsetWidth+this.offsetHeight)==0){return false}return true},toggleDisplay:function(){return $chk(this)&&this.getStyle("display")=="none"?this.setStyle("display",""):this.setStyle("display","none")},getFormElementsPlus:function(c){var b=[];var a=$$(this.getElements("input"),this.getElements("select"),this.getElements("textarea"));if(c){a=a.filter(c)}a.each(function(e){var d=e.name;var f=e.getValue();if(!d||!f){return}if(e.getProperty("type")=="checkbox"||e.getProperty("type")=="radio"){if(!!e.getProperty("checked")){return b.include($(e).toHiddenInput())}return}b.include(e)});return $$(b)},toHiddenInput:function(){return new Element("input",{type:"hidden",name:this.name,value:this.value})},clearEmptyText:function(){var a=$(this).retrieve("et",this.get("emptyText"));if(this.value==a){this.value=""}this.focus()}});String.extend({format:function(){if(arguments.length==0){return this}var d=/{(\d+)?}/g;var c=arguments;var b=this;var a=this.replace(d,function(f,e){return c[e.toInt()]||""});return a},toFormElements:function(){if(!this.contains("=")&&!this.contains("&")){return new Element("input",{type:"hidden"})}var a=[];var b=this.split("&");$A(b).each(function(c){if(c.contains("=")){c=$A(c.split("="));a.push(new Element("input",{type:"hidden",name:c[0],value:decodeURIComponent(c[1])}))}else{a.push(new Element("input",{type:"hidden",name:c}))}});return new Elements(a)},getLength:function(a){var b=this;len=0;for(i=0;i<b.length;i++){iCode=b.charCodeAt(i);if((iCode>=0&&iCode<=255)||(iCode>=65377&&iCode<=65439)){len+=1}else{len+=a||3}}return len},limitLength:function(){var c=this;var b=Array.flatten(arguments);var a=c.getLength();b[0]=b[0]||0;b[1]=b[1]||1;if(a>=b[0]&&a<=b[1]){return true}return false}});var ItemAgg=new Class({Implements:[Events,Options],options:{onActive:Class.empty,onBackground:Class.empty,show:0,eventName:"click",activeName:"cur",firstShow:true},initialize:function(c,a,b){this.setOptions(b);this.tabs=$$(c);this.items=$$(a);this.items.setStyle("display","none");this.tempCurIndex=this.options.show||0;if(this.options.firstShow){this.show(this.tempCurIndex)}this.tabs.each(function(e,d){e.addEvent(this.options.eventName,function(f){f=new Event(f).stop();this.render(d)}.bind(this))},this)},render:function(a){this.tabs[a].blur();if(this.tempCurIndex!=a){this.show(a);this.hide(this.tempCurIndex);this.tempCurIndex=a}},show:function(a){this.items[a].show();this.tabs[a].addClass(this.options.activeName);this.fireEvent("onActive",[this.tabs[a],this.items[a]],this)},hide:function(a){this.items[a].hide();this.tabs[a].removeClass(this.options.activeName);this.fireEvent("onBackground",[this.tabs[a],this.items[a]],this)}});var _S=$,_SES=$ES,_SS=$$,_SE=$E;function $cleanNull(){var a=arguments[0];for(p in a){if(!a[p]){delete (a[p])}}return a}var tagInputer=new Class({initialize:function(a,b){this.input=a;this.btns=b.addEvent("click",this.toggle.bind(this))},setBtns:function(a){this.btns=a.addEvent("click",this.toggle.bind(this))},toggle:function(a){a=$(new Event(a).target);if(a.hasClass("checked")){this.removeTag(a.getText());a.removeClass("checked")}else{this.addTag(a.getText());a.addClass("checked")}},addTag:function(b){var a=this.input.value.split(/\s+/);this.input.value=a.include(b).join(" ").trim()},removeTag:function(b){var a=this.input.value.split(/\s+/);this.input.value=a.remove(b).join(" ").trim()},set:function(a){if(!a){return}this.input.value=a.join(" ").trim();var b={};a.each(function(c){this[c]=1}.bind(b));this.btns.each(function(c){if(this[c.getText()]){c.addClass("checked")}else{c.removeClass("checked")}}.bind(b))}});var attachEsayCheck=function(d,c,e){e=e||$empty;var d=$(d);if(!d){return}var b=d.getElements(c);if(!b.length){return}var a;d.addEvents({mousedown:function(f){d.store("eventState",f.type);a=false},mouseup:function(f){d.store("eventState",f.type)}});b.addEvent("mouseover",function(){if(d.retrieve("eventState")!="mousedown"){return}var f=$pick(this.match("input")?this:null,this.getElement("input"));if(!f){return}if(f.get("disabled")){return}if(!a){a=f.set("checked",!f.get("checked"));a.fireEvent("change");e(a);return}f.set("checked",a.get("checked"));f.fireEvent("change");e(f)})};function viewIMG(e,b){var d=$(b);d.addClass("viewIMG_Loading");var c=($("imgViewBox")||new Element("div",{id:"imgViewBox"}).setStyles({border:"4px #000 solid",padding:2,background:"#ffffff",position:"absolute",zIndex:65535,top:-2000}).inject(document.body)).empty().setHTML("<div style='padding:5px;'><span style='display:block;text-align:right;cursor:pointer;border-top:1px #ccc solid;' onclick='$(\"imgViewBox\").hide()'>关闭</span></div>");var a=new Asset.image(e,{onload:function(){var f=$(this);if(f.$e){return}f.injectTop(c);c.show().amongTo(window);d.removeClass("viewIMG_Loading");f.$e=true},onerror:function(){alert("加载图片失败");d.removeClass("viewIMG_Loading")}})}_open=function(b,a){a=$extend({width:window.getSize().x*0.8,height:window.getSize().y*0.8},a||{});var c="toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width={width},height={height}";c=c.substitute(a);window.open(b||"about:blank","_blank",c)};window.init_select=function(a){this.empty();new Request.JSON({secure:1,onComplete:function(b){this.removeEvent("focus",window.init_select);$H(b).each(function(d,c){new Element("option",{value:d}).setText(c).inject(this)}.bind(this))}.bind(this)}).get(this.get("remote_url"))};window.obj_finder_call_back=function(b){if(!this.getAttribute("multiple")){var d=b.getElement(".dialog-content-body").getElement("input[checked]");if(!d){return}if(this.getElement("input")){this.getElement("input").value=d.value}if(this.getElement(".label")){this.getElement(".label").setText(d.getNext("label").getText())}}else{var c=this.getParent("div[params]");var e=[];b.getElement(".dialog-content-body").getElements("input[checked]").each(function(g){if(!$E("input[item_id="+g.value+"]",c)){e.push(g.value)}});var a=new Request({onComplete:function(g){c.getElement(".rows-body").innerHTML+=g}});var f=JSON.decode(c.get("params"));a.post("index.php?ctl=editor&act=object_rows",{data:e,iptname:f.name,object:f.object,cols:f.cols,view:f.view})}};