var dataSyncLock=false;var dataSyncStep=1;var dataSyncHalt=false;var doDataSync=function(a){a=a?true:false;dataSyncLock=true;new Request({data:"step="+dataSyncStep,onSuccess:function(b){var c=true;dataSyncHalt=false;try{b=$H(JSON.decode(b))}catch(d){return}if(b.get("status")=="continue"){dataSyncStep++;if($("supplier-list")){if(b.has("joblist")){b.get("joblist").each(function(e){var f=new Element("img",{src:"images/sync_loading.gif",title:"正在同步","class":"data-sync-loading"});$E("#supplier-list tr[supplierid="+e+"] .supplier-sync-status").empty().adopt(f)})}}doDataSync()}else{if(b.get("status")=="lock"){alert("更新列表下载锁定中，请30秒后刷新页面重试！");c=false}dataSyncStep=1;dataSyncLock=false;this.cancel()}if(!a&&!goodsSyncLock&&c){doGoodsSync()}},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")));dataSyncHalt=true}else{dataSyncStep++;setTimeout("doDataSync()",5000)}}}).post("index.php?ctl=distribution/supplier&act=doDataSync")};var autoSyncStep=new Array();var autoSyncHalt=false;var doAutoSync=function(a){if(!dataSyncLock&&!goodsSyncLock&&!imagesSyncLock&&!supplierApiListJobLock){_doAutoSync(a,0)}else{setTimeout("doAutoSync("+a+")",5000)}};var _doAutoSync=function(a,b){autoSyncStep[a]=b;new Request({data:"supplier_id="+a+"&step="+autoSyncStep[a],onSuccess:function(d){try{d=$H(JSON.decode(d))}catch(g){return}if(d.op_id==6||d.op_id==8){doImagesSync(d.command_id)}var h=$E("#supplier-list tr[supplierid="+a+"] .supplier-sync-status");if(h!=null){img=$E("img",h);if(img.id!="sync_img_"+a){var f=new Element("img",{src:"images/sync_loading.gif",title:"正在同步",id:"sync_img_"+a});h.empty().adopt(f)}}if(d.status=="done"){autoSyncStep[a]=0;var h=$E("#supplier-list tr[supplierid="+a+"] .supplier-sync-status");if(h!=null){var c=new Element("img",{src:"images/success.gif",title:"同步完成"});h.empty().adopt(c)}this.cancel()}else{_doAutoSync(a,d.count)}},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")))}else{setTimeout("_doAutoSync("+a+","+autoSyncStep[a]+")",5000)}}}).post("index.php?ctl=distribution/supplier&act=doAutoSync")};var autoSyncJobHalt=false;var doAutoSyncJob=function(){new Request({data:"",onSuccess:function(a){autoSyncJobHalt=false;try{a=JSON.decode(a)}catch(b){return}a.each(function(c){_doAutoSync(c.supplier_id,0)})},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")));autoSyncJobHalt=true}else{setTimeout("doAutoSyncJob()",5000)}}}).post("index.php?ctl=distribution/supplier&act=autoSyncJob")};var costSyncStep=new Array();var doCostSync=function(a,b){costSyncStep[a]=b;new Request({data:"supplier_id="+a+"&step="+costSyncStep[a],onSuccess:function(d){try{d=$H(JSON.decode(d))}catch(f){return}if(d.status=="done"){costSyncStep[a]=0;var g=$E("#supplier-list tr[supplierid="+a+"] .supplier-cost-sync-status");if(g!=null){var c=new Element("img",{src:"images/success.gif",title:"同步完成"});g.empty().adopt(c);if(!d.count){alert("此次更新无采购价变更")}}this.cancel()}else{doCostSync(a,d.count)}},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")))}else{setTimeout("doCostSync("+a+","+costSyncStep[a]+")",5000)}}}).post("index.php?ctl=distribution/supplier&act=doCostSync")};var costSyncJobHalt=false;var doCostSyncJob=function(){new Request({data:"",onSuccess:function(a){costSyncJobHalt=false;try{a=JSON.decode(a)}catch(b){return}a.each(function(c){doCostSync(c.supplier_id,c.num)})},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")));costSyncJobHalt=true}else{setTimeout("doCostSyncJob()",5000)}}}).post("index.php?ctl=distribution/supplier&act=costSyncJob")};var goodsSyncLock=false;var goodsSyncStep=1;var goodsSyncHalt=false;var doGoodsSync=function(){goodsSyncLock=true;new Request({data:"step="+goodsSyncStep,onSuccess:function(a){var b=true;goodsSyncHalt=false;try{a=$H(JSON.decode(a))}catch(c){return}if(a.get("status")=="continue"){goodsSyncStep++;$("head_sync_download_tip_msg").set("styles",{display:""});$("downmsg").set("text",a.get("msg"));doGoodsSync()}else{if(a.get("status")=="lock"){alert("商品下载锁定中，请30秒后刷新页面重试！");b=false}goodsSyncStep=1;goodsSyncLock=false;this.cancel()}if(a.has("cat_id")&&a.get("cat_id")){new Dialog("index.php?ctl=distribution/supplier&act=syncComplete",{title:"下载完成",width:300,height:200,ajaxoptions:{data:"cat_id="+a.get("cat_id"),method:"post",ajaksable:false}});$("head_sync_download_tip_msg").set("styles",{display:"none"})}if(!imagesSyncLock&&b){doImagesSync(null)}},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")));goodsSyncHalt=true}else{goodsSyncStep++;setTimeout("doGoodsSync();",5000)}}}).post("index.php?ctl=distribution/supplier&act=doGoodsSync")};var imagesSyncLock=false;var imagesSyncStep=1;var imagesSyncHalt=false;var doImagesSync=function(b){imagesSyncLock=true;if(b){var a="step="+imagesSyncStep+"&command_id="+b}else{var a="step="+imagesSyncStep}new Request({data:a,onSuccess:function(c){imagesSyncHalt=false;try{c=$H(JSON.decode(c))}catch(d){return}if(c.get("status")=="continue"){imagesSyncStep++;doImagesSync(b)}else{imagesSyncStep=1;imagesSyncLock=false;this.cancel()}},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")));imagesSyncHalt=true}else{imagesSyncStep++;setTimeout("doImagesSync(null);",5000)}}}).post("index.php?ctl=distribution/supplier&act=doImagesSync")};var supplierApiListJobLock=false;var supplierApiListJobHalt=false;var doSupplierApiListJob=function(c,a,b){supplierApiListJobLock=true;new Request({data:"",onSuccess:function(d){supplierApiListJobHalt=false;try{d=$H(JSON.decode(d))}catch(f){return}if(d.status=="continue"){doSupplierApiListJob(c,a,b)}else{this.cancel();supplierApiListJobLock=false}},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")));supplierApiListJobHalt=true}else{setTimeout("doSupplierApiListJob("+c+",'"+a+"','"+b+"')",5000)}}}).post("index.php?ctl=distribution/supplier&act=doSupplierApiListJob&p[0]="+c+"&p[1]="+a+"&p[2]="+b)};var supplierApiListHalt=false;var doSupplierApiList=function(){new Request({data:"",onSuccess:function(a){supplierApiListHalt=false;try{a=JSON.decode(a)}catch(b){return}a.each(function(c){doSupplierApiListJob(c.supplier_id,"","")})},onFailure:function(){if(this.xhr.status==501&&this.getHeader("notify_msg")){alert(decodeURIComponent(this.getHeader("notify_msg")));supplierApiListHalt=true}else{setTimeout("doSupplierApiList()",5000)}}}).post("index.php?ctl=distribution/supplier&act=suppilerApiList")};var notice_first=true;var first=true;function api_notice(){new Request({onSuccess:function(a){if(a){$("head_sync_download_tip_msg").set("styles",{display:""});$("downmsg").set("text",a);if(notice_first){alert(a);notice_first=false}}else{if(!first){if(supplierApiListHalt){doSupplierApiList()}if(dataSyncHalt){doDataSync()}if(goodsSyncHalt){doGoodsSync()}if(imagesSyncHalt){doImagesSync(null)}if(autoSyncJobHalt){doAutoSyncJob()}if(costSyncJobHalt){doCostSyncJob()}if(!goodsSyncLock){$("head_sync_download_tip_msg").set("styles",{display:"none"});$("downmsg").set("text","")}}else{doSupplierApiList();doDataSync();doGoodsSync();doImagesSync(null);doAutoSyncJob();doCostSyncJob();first=false}}}}).get("index.php?ctl=default&act=check_api_maintenance","");arguments.callee.delay(600000)}addEvent("load",function(){api_notice()});