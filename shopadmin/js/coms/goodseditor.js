var ShopExGoodsEditor=new Class({Implements:[Options],options:{periodical:false,delay:500,postvar:"finderItems",varname:"items",width:500,height:400},initialize:function(b,a){this.el=$(b);this.setOptions(a);this.cat_id=$("gEditor-GCat-input").getValue();this.type_id=$("gEditor-GType-input").getValue();this.goods_id=$("gEditor-GId-input").getValue();this.initEditorBody.call(this)},initEditorBody:function(){var d=this;var c=$("gEditor-GCat-input");var b=$("gEditor-GType-input");c.addEvent("change",function(h){var g=$(this.options[this.selectedIndex]);var f=g.get("type_id")||1;if(f!=b.getValue()){a("cat",(function(){if(b.getValue()==1){b.getElement("option[value="+f+"]").set("selected",true);MODALPANEL.show();d.updateEditorBody.call(d)}else{if(confirm("\t是否根据所选分类的默认类型重新设定商品类型？\n\n如果重设，可能丢失当前所输入的类型属性、关联品牌、参数表等类型相关数据。")||this.getValue()<0){b.getElement("option[value="+f+"]").set("selected",true);MODALPANEL.show();d.updateEditorBody.call(d)}}}).bind(this),(function(i){alert(i)}).bind(this))}d.cat_id=this.getValue()});b.addEvent("click",function(){this.store("tempvalue",this.getValue())});b.addEvent("change",function(g){var f=this.retrieve("tempvalue");a("type",(function(h){if(this.getValue()&&confirm("是否根据所选类型的默认类型重现设定商品类型？\n如果重设，可能丢失当前所输入的类型属性，关联品牌，参数表等类型相关数据")){MODALPANEL.show();d.updateEditorBody.call(d);d.type_id=this.getValue()}else{this.getElement("option[value="+f+"]").set("selected",true)}}).bind(this),(function(h){alert(h);this.getElement("option[value="+f+"]").set("selected",true)}).bind(this))});var a=function(e,g,f){new Request({data:$("x-g-basic").toQueryString(),onRequest:function(){$("loadMask").show()},onComplete:function(h){$("loadMask").hide();if(h=="1"){g()}else{f(h)}}}).post("index.php?ctl=goods/gtype&act=typeTransformCheck&p[0]="+e)};MODALPANEL.hide()},updateEditorBody:function(){cb=$defined(arguments[0])?arguments[0]:function(){void (0)};$ES("#gEditor textarea[ishtml=true]").getValue();W.page("index.php?ctl=goods/product&act=update",{update:"gEditor-Body",data:$("gEditor").toQueryString()+"&pic_bar="+encodeURIComponent($E("#action-pic-bar .pic-area").get("html")),method:"post",onComplete:function(){this.initEditorBody.call(this);var a=$E("#gEditor .gpic-box .current");if(a){a.onclick()}cb()}.bind(this)})},mprice:function(b){for(var c=b.parentNode;c.tagName!="TR";c=c.parentNode){}var a={};$ES("input",c).each(function(d){if(d.name=="price[]"){a.price=d.value}else{if(d.name=="goods[price]"){a.price=d.value}else{if(d.getAttribute("level")){a["level["+d.getAttribute("level")+"]"]=d.value}}}});window.fbox=new Dialog("index.php?ctl=goods/product&act=mprice",{ajaxoptions:{data:a,method:"post"},modal:true});window.fbox.onSelect=goodsEditor.setMprice.bind({base:goodsEditor,el:c})},setMprice:function(a){var b={};a.each(function(c){b[c.name]=c.value});$ES("input",this.el).each(function(c){var e=c.getAttribute("level");if(e&&b[e]!=undefined){c.value=b[e]}})},spec:{addCol:function(b,a){this.dialog=new Dialog("index.php?ctl=goods/spec&act=addCol&_form="+(b?b:"goods-spec")+"&type_id="+a,{ajaxoptions:{data:$("goods-spec").toQueryString()+($("nospec_body")?"&"+$("nospec_body").toQueryString():""),method:"post"},title:"规格"})},addRow:function(){this.dialog=new Dialog("index.php?ctl=goods/spec&act=addRow",{ajaxoptions:{data:$("goods-spec"),method:"post"}})}},adj:{addGrp:function(a){this.dialog=new Dialog("index.php?ctl=goods/adjunct&act=addGrp&_form="+(a?a:"goods-adj"))}},pic:{del:function(b,d){if(confirm("确认删除本图片吗?")){d=$(d);var a=d.getParent(".gpic-box");try{if(b){new Request({url:"index.php?ctl=goods/product&act=removePic",onSuccess:function(){a.remove();if($E("#all-pics .gpic-box .current")){return}if($$("#all-pics .gpic-box").length&&$$("#all-pics .gpic-box").length>0){$("x-main-pic").empty().set("html",'<div class="notice" style="margin:0 auto">请重新选择默认商品图片.</div>')}else{$("x-main-pic").empty().set("html",'<div class="notice" style="margin:0 auto">您还未上传商品图片.</div>')}}}).send({ident:b})}}catch(c){a.remove()}}},setDefault:function(c,b){if(isNaN(c)){return}if($("x-main-pic").retrieve("cururl")==b){return}$("x-main-pic").store("cururl","loading");var a=this.getDefault();if(a){a=$E("#all-pics img[sn=_img_"+a+"]");if(a){a.getParent("span").removeClass("current")}}if($E("#x-main-pic input[name=image_default]")){$E("#x-main-pic input[name=image_default]").set("value",c)}else{$("x-main-pic").empty();new Element("input",{type:"hidden",name:"image_default"}).set("value",c).inject("x-main-pic")}if(_temimg=$("x-main-pic").getElements("img")){if(_temimg.length){_temimg.remove()}}$("x-main-pic").addClass("x-main-pic-loading");new Asset.image(b,{onload:function(d){var e=$(d.zoomImg(290,220));e.inject($("x-main-pic"));e.setStyle("margin-top",Math.abs((220-e.height.toInt())/2));$("x-main-pic").removeClass("x-main-pic-loading");$("x-main-pic").store("cururl",b)},onerror:function(){$("x-main-pic").removeClass("x-main-pic-loading");$("x-main-pic").store("cururl","")}});$E("#all-pics img[sn=_img_"+c+"]").getParent("span").addClass("current")},getDefault:function(){var a=$E("#x-main-pic input[name=image_default]");if(a){return a.value}else{return false}},viewSource:function(a){return new Dialog(a,{title:"查看图片信息",singlon:false,width:650,height:300})}},rateGoods:{add:function(){window.fbox=new Dialog("index.php?ctl=goods/product&act=select",{modal:true,ajaxoptions:{data:{onfinish:"goodsEditor.rateGoods.insert(data)"},method:"post"}})},del:function(){},insert:function(a){$ES("div.rate-goods").each(function(b){a["has["+b.getAttribute("goods_id")+"]"]=1});new Ajax("index.php?ctl=goods/product&act=ratelist",{data:a,onComplete:function(b){$("x-rate-goods").innerHTML+=b}}).request()}}});