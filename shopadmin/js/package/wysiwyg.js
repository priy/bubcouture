var mceInstance=new Class({Implements:[Events,Options],options:{acitve:false,maskOpacity:0.5,autoHeight:false,cleanup:true,includeBase:true},initialize:function(a,c){this.seri=a;var b="mce_body_"+a;this.el=$(b);this.setOptions(c);this.input=$E("textarea",this.el).setProperty("ishtml","true");this.frmContainer=$(b+"_frm_container");var d=this;var g=this.options.includeBase;var f=0;var e=this.frm=new Element("iframe",{src:"blank.html?editor",id:b+"_frm",name:b+"_frm",frameborder:0,border:0}).addEvent("load",function(){if(f){return}f=1;var j=d;var k=e.contentWindow;var h="<base href="+SHOPBASE+"/>";var i="<html><head>"+(g?h:"")+'<script>window.onerror=function(){return false;}<\/script><link rel="stylesheet" type="text/css" href="'+SHOPADMINDIR+'wysiwyg_editor.css"/></head><body spellcheck="false" id="'+a+'">'+(j.cleanup(j.input.getProperty("value"))||"&nbsp;")+"</body></html>";k.document.open();k.document.write(i);k.document.close();k.document.designMode="on";k=new Window(k);new Document(k.document).addEvent("mousedown",j.active.bind(j));j.win=k;j.doc=k.document;j.input.setAttribute("filled","true");this.removeEvent("load",arguments.callee)});e.inject(this.frmContainer);this.input.getValue=function(){if(!this.input.getAttribute("filled")){return"textarea-unfilled"}if("textarea"==this.editType){return this.input.value}var h=this.getValue();this.input.value=h;return h}.bind(this);if(this.options.autoHeight){this.autoHeight.call(this)}if($(b)){this.el=$(b).setStyle("visibility","visible")}},autoHeight:function(){try{this.frm.setStyle("height",this.doc.body.offsetHeight+50)}catch(a){}},setValue:function(){this.doc.body.innerHTML=this.input.value},getValue:function(){return this.cleanup(this.doc.body.innerHTML)},regexpReplace:function(e,a,c,d){if(e==null){return e}if(typeof(d)=="undefined"){d="g"}var b=new RegExp(a,d);return e.replace(b,c)},cleanup:function(c){var b="<br/>";var h=[[/(<(?:img|input)[^\/>]*)>/g,"$1 />"]];var a=[[/<li>\s*<div>(.+?)<\/div><\/li>/g,"<li>$1</li>"],[/<span style="font-weight: bold;">(.*)<\/span>/gi,"<strong>$1</strong>"],[/<span style="font-style: italic;">(.*)<\/span>/gi,"<em>$1</em>"],[/<b\b[^>]*>(.*?)<\/b[^>]*>/gi,"<strong>$1</strong>"],[/<i\b[^>]*>(.*?)<\/i[^>]*>/gi,"<em>$1</em>"],[/<u\b[^>]*>(.*?)<\/u[^>]*>/gi,'<span style="text-decoration: underline;">$1</span>'],[/<p>[\s\n]*(<(?:ul|ol)>.*?<\/(?:ul|ol)>)(.*?)<\/p>/ig,"$1<p>$2</p>"],[/<\/(ol|ul)>\s*(?!<(?:p|ol|ul|img).*?>)((?:<[^>]*>)?\w.*)$/g,"</$1><p>$2</p>"],[/<br[^>]*><\/p>/g,"</p>"],[/<p([^>]*)>(.*?)<\/p>(?!\n)/g,"<p$1>$2</p>\n"],[/<\/(ul|ol|p)>(?!\n)/g,"</$1>\n"],[/><li>/g,">\n\t<li>"],[/([^\n])<\/(ol|ul)>/g,"$1\n</$2>"],[/([^\n])<img/ig,"$1\n<img"],[/^\s*$/g,""]];var g=[[/\s*<br ?\/?>\s*<\/p>/gi,"</p>"]];var f=[[/<br class\="webkit-block-placeholder">/gi,"<br />"],[/<span class="Apple-style-span">(.*)<\/span>/gi,"$1"],[/ class="Apple-style-span"/gi,""],[/<span style="">/gi,""],[/^([\w\s]+.*?)<div>/i,"<p>$1</p><div>"],[/<div>(.+?)<\/div>/ig,"<p>$1</p>"]];var d=[[/<em>\s*<\/em>/gi,""],[/<strong>\s*<\/strong>/gi,""],[/<br\s*\/?>/gi,b],[/<br\/?>\s*<\/(h1|h2|h3|h4|h5|h6|li|p)/gi,"</$1"],[/<p>\s*<br\/?>\s*<\/p>/gi,"<p>\u00a0</p>"],[/<p>(&nbsp;|\s)*<\/p>/gi,"<p>\u00a0</p>"],[/<\/p>\s*<\/p>/g,"</p>"],[/<[^> ]*/g,function(i){return i.toLowerCase()}],[/<[^>]*>/g,function(i){i=i.replace(/ [^=]+=/g,function(j){return j.toLowerCase()});return i}],[/<[^>]*>/g,function(i){i=i.replace(/( [^=]+=)([^"][^ >]*)/g,'$1"$2"');return i}]];var e=[[/<p>\s*<br ?\/?>\s*<\/p>/gi,"<p>\u00a0</p>"],[/<br>/gi,"<br />"],[/><br ?\/?>/gi,">"],[/<br ?\/?>\s*<\/(h1|h2|h3|h4|h5|h6|li|p)/gi,"</$1"],[/<p>(?:\s*)<p>/g,"<p>"],];d.extend(h);d.extend(a);if(Browser.Engine.webkit){d.extend(f)}d.each(function(i){c=c.replace(i[0],i[1])});c=c.trim();return c},active:function(){if(!this.actived){this.actived=true;this.doc.addEvent("click",function(a){this.fireEvent("docClick",new Event(a))}.bind(this))}this.fireEvent("active",this)},sleep:function(){}});var mceHandler=new Class({Implements:[Events,Options],initialize:function(c,a,b){try{this.el=$(c);$ES("img",this.el).each(function(f){new DropMenu(f)});this.setOptions(b);if(a){if(a.length){a.each(this.addInstance.bind(this))}else{this.addInstance.call(this,a)}}}catch(d){alert(d.message)}if("style_init" in this){this.style_init()}},addInstance:function(a){a.addEvent("active",this.active.bind(this));a.addEvent("docClick",this.docClick.bind(this))},active:function(a){this.inc=a;if(this.inc){this.inc.sleep.call(this.inc)}},docClick:function(b){var a=this.currentEl=b.target||b.srcElement;this.fireEvent("click",b)},getRange:function(){if(!this.inc){return false}if(this.range){return this.range}return window.ie?this.inc.doc.selection.createRange():this.inc.win.getSelection()},getSelection:function(){return window.ie?this.inc.doc.selection:this.inc.win.getSelection()},getRangeText:function(){return window.ie?this.inc.doc.selection.createRange().text:this.inc.win.getSelection().toString()},exec:function(c,b){if(!this.busy){this.busy=true;if(!c||!this.inc){return}if(this.dlg){if(window.ie){if(this.range){this.range.select()}}this.dlg.hide();this.dlg=null}switch(c){case"formatblock":this.inc.doc.execCommand("FormatBlock",false,"<"+b+">");break;case"wrap":this.exec("insertHTML",b[0]+this.getRangetext()+b[1]);break;case"insertHTML":if(window.ie){this.getSelection().clear()}if(this.replaceEl&&this.replaceEl.tagName&&!this.replaceEl.tagName.match(/body/g)){try{var a=this.inc.doc.createElement("div");a.innerHTML=b;a=a.firstChild;this.replaceEl.parentNode.replaceChild(a,this.replaceEl)}catch(d){MessageBox.error(d)}finally{this.replaceEl=null}}else{if(window.ie){this.inc.win.focus();this.range=null;this.getRange().pasteHTML(b)}else{this.inc.doc.execCommand("inserthtml",false,b)}}break;default:try{this.inc.doc.execCommand(c,false,b)}catch(d){MessageBox.error(d)}}this.busy=false}},mklink:function(){if(!this.inc){return}this.replaceEl=null;var a=this.currentEl;var b;if("body"==a.tagName.toLowerCase()&&!this.getRangeText()){return}if(a&&a.tagName&&a.tagName.toLowerCase()=="img"){return MessageBox.error("对不起,目前不支持对已插入图片增加超连接.")}if(a&&a.tagName&&a.tagName.toLowerCase()=="a"){b={text:this.currentEl.innerHTML,href:this.currentEl.href,alt:this.currentEl.alt,title:this.currentEl.title,target:this.currentEl.target};this.replaceEl=a}else{b={text:this.getRangeText()}}this.dialog("link",{height:null,width:450,ajaxoptions:{method:"post",data:b}})},editHTML:function(){var d=this;if(!this.inc){return}var b=$("mce_handle_htmledit_"+this.inc.seri);var a=$("mce_handle_"+this.inc.seri);this.inc.input.getValue();b.show();a.hide();var c=this.inc.frm.getSize();this.inc.input.show();this.inc.frmContainer.hide();b.getElement(".returnwyswyg").addEvent("click",function(){a.show();b.hide();d.inc.doc.body.innerHTML=d.inc.input.value.clean().trim();d.inc.input.hide();d.inc.frmContainer.show();d.inc.editType="wysiwyg";this.removeEvent("click",arguments.callee)});this.inc.editType="textarea"},dialog:function(b,a){if(!this.inc){return}this.inc.win.focus();this.range=null;this.range=this.getRange();a=$cleanNull(a);this.dlg=new Dialog("index.php?ctl=editor&act="+b,$merge(a,{modal:true}));window.curEditor=this},queryValue:function(a,b){if(a=="align"){a="justifyRight"}try{if(b){return this.inc.doc.queryCommandState(a)}else{return this.inc.doc.queryCommandValue(a)}}catch(c){}},queryValues:function(){var a={};var c=["Bold","Italic","Underline","strikeThrough","subscript","superscript","insertOrderedList","insertUnorderedList"];for(var b=0;b<arguments.length;b++){a[arguments[b]]=this.queryValue(arguments[b],c.contains(arguments[b]))}return a}});
var editor_style_1=new Abstract({style_init:function(){this.mce_handle=this.el;this.addEvent("click",this.status.bind(this));this.addEvent("click",function(b){if(!this.$init){this.mce_handle.setOpacity(1);if(this.inc.doc.body.innerHTML.substr(0,6)=="&nbsp;"){this.inc.doc.body.innerHTML=this.inc.doc.body.innerHTML.slice(6)}var a=this;$ES("img",this.mce_handle).addEvent("click",function(){this.inc.win.focus()}.bind(this));$E(".ft_select",this.mce_handle).addEvent("change",function(d){var c=this.getValue();if(!c){return}if(window.ie&&a.range){a.range.select()}a.set("fontName",c)});$E(".fs_select",this.mce_handle).addEvent("change",function(d){var c=this.getValue();if(!c){return}if(window.ie&&a.range){a.range.select()}a.set("fontSize",c)});$$($E(".fontColorPicker",this.el),$E(".fontBGColorPicker",this.el),$E(".ft_select",this.mce_handle),$E(".fs_select",this.mce_handle)).addEvent("click",function(){this.range=null;if(window.ie&&this.getSelection().type.toLowerCase()!="none"){this.range=this.getRange()}if(!window.ie){this.range=this.getRange()}}.bind(this));new GoogColorPicker($E(".fontColorPicker",this.el),{onSelect:function(d,c,f){if(window.ie&&this.range){this.range.select()}this.set("forecolor",d)}.bind(this),onShow:function(c){if(window.ie&&this.range){this.range.select()}}.bind(this)});new GoogColorPicker($E(".fontBGColorPicker",this.el),{onSelect:function(d,c,f){if(window.ie){if(this.range){this.range.select()}return this.set("backColor",d)}this.set("hilitecolor",d)}.bind(this),onShow:function(c){if(window.ie&&this.range){this.range.select()}}.bind(this)})}this.$init=true}.bind(this));this.styler=$ES(".x-section",this.el);this.stylerEl=$ES(".x-style",this.el);this.align=$ES(".x-align",this.el);this.setting=$ES(".x-enable",this.el)},status:function(c){new Event(c);if(!this.target){this.target=c.target.getElementsByTagName("body")[0]||c.target}var b=this.target.style;if(b["background-color"]=="transparent"){b["background-color"]="#fff"}this.styler.setStyle("background-color",(b["background-color"]=="transparent")?"#fff":b["background-color"]);this.stylerEl.setStyle("color",b.color);var a=this.queryValues("Bold","Italic","Underline","strikeThrough","subscript","superscript","align","CreateLink","FontName","FontSize","ForeColor","FormatBlock","insertOrderedList","insertUnorderedList");if(a.align=="center"){this.align[0].parentNode.className="";this.align[1].parentNode.className="in";this.align[2].parentNode.className=""}else{if(a.align=="right"){this.align[0].parentNode.className="";this.align[1].parentNode.className="";this.align[2].parentNode.className="in"}else{if(a.align=="left"){this.align[0].parentNode.className="in";this.align[1].parentNode.className="";this.align[2].parentNode.className=""}else{this.align[0].parentNode.className="";this.align[1].parentNode.className="";this.align[2].parentNode.className=""}}}this.setting.each(function(d){d.parentNode.className=a[d.getAttribute("value")]?"in":""})},set:function(b,a){if(!this.inc||!this.inc.win){return}if(window.ie){this.inc.win.focus()}this.exec(b,a);try{this.status.call(this)}catch(c){}}});
