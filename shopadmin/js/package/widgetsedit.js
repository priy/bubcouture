Element.extend({getCis:function(){return this.getCoordinates()}});String.extend({format:function(){if(arguments.length==0){return this}var d=/{(\d+)?}/g;var c=arguments;var b=this;var a=this.replace(d,function(f,e){return c[e.toInt()]||""});return a}});var Scroller=new Class({Implements:[Events,Options],options:{area:20,velocity:1,onChange:function(a,b){this.element.scrollTo(a,b)}},initialize:function(b,a){this.setOptions(a);this.element=$(b);this.listener=($type(this.element)!="element")?$(this.element.getDocument().body):this.element;this.timer=null;this.coord=this.getCoords.bind(this)},start:function(){this.listener.addEvent("mousemove",this.coord)},stop:function(){this.listener.removeEvent("mousemove",this.coord);this.timer=$clear(this.timer)},getCoords:function(a){this.page=(this.listener.get("tag")=="body")?a.client:a.page;if(!this.timer){this.timer=this.scroll.periodical(50,this)}},scroll:function(){var b=this.element.getSize(),a=this.element.getScroll(),e=this.element.getPosition(),d={x:0,y:0};for(var c in this.page){if(this.page[c]<(this.options.area+e[c])&&a[c]!=0){d[c]=(this.page[c]-this.options.area-e[c])*this.options.velocity}else{if(this.page[c]+this.options.area>(b[c]+e[c])&&b[c]+b[c]!=a[c]){d[c]=(this.page[c]-b[c]+this.options.area-e[c])*this.options.velocity}}}if(d.y||d.x){this.fireEvent("change",[a.x+d.x,a.y+d.y])}}});var DragDropPlus=new Class({Implements:[Options,Events],options:{ddScope:window,onInitDrags:$empty,onInitDrops:$empty,onEdit:$empty,onDelete:$empty},initialize:function(b,c,a){this.dragSelecterString=b;this.dropSelecterString=c;this.drags=$$(b);this.drops=$$(c);this.setOptions(a);if(this.options.ddScope){this.winScroll=new Scroller(this.options.ddScope,{velocity:1})}this.drag_operate_box=$("drag_operate_box");if(!this.drag_operate_box){return}this.drag_operate_box.store("lock",false);this.drag_handle_box=$E(".drag_handle_box",this.drag_operate_box);this.dobFx=this.drag_operate_box.effects({fps:50,duration:200,link:"cancel"});this.dragSign=$("drag_ghost_box").inject(document.body);this.initDOBBase(this.drops);this.initDrags(this.drags);this.initDrops(this.drops)},checkEmptyDropPanel:function(a){if(!a||!a.hasClass(this.dropSelecterString.substring(1,this.dropSelecterString.length))){return}if(!a.getElement(this.dragSelecterString)){if(!a.getElement(".empty_drop_box")){new Element("div",{"class":"empty_drop_box"}).setText("空板块区域").inject(a);if(this.dragmoveInstance){a.store("droppanel",true);this.dragmoveInstance.droppables.include(a)}}}else{if(a.getElement(".empty_drop_box")){a.getElement(".empty_drop_box").remove()}}},dragLeave:function(){},dargInject:function(a,c){var d=this.dragging;if(!d){return}var b="inside";if(!c.retrieve("droppanel")){b=d.getAllPrevious().contains(c)?"before":"after"}d.inject(c,b);this.checkEmptyDropPanel(a.retrieve("droped"));this.checkEmptyDropPanel(c);a.store("droped",c);this.dragSign.setStyles(d.getCis())},getDropables:function(){var b=this.dragging;var a=$A(this.drags).remove(b).concat(this.drops.filter(function(c){if($E(this.dragSelecterString,c)){c.store("droppanel",false);return false}else{c.store("droppanel",true);return true}}.bind(this)));return a},initDOBBase:function(e){var d=this.drag_operate_box;var b=this.drag_handle_box;var c=this;if(!e){return}var a=this.winScroll;$E(".dhb_edit",b).addEvent("click",function(f){f.stop();this.fireEvent("onEdit",[d.retrieve("drag")],this)}.bind(this));$E(".dhb_del",b).addEvent("click",function(f){f.stop();this.fireEvent("onDelete",[d.retrieve("drag")],this)}.bind(this));$E(".dhb_title",b).addEvents({mousedown:function(f){c.dragging=d.retrieve("drag");d.setStyle("left",d.getPosition().x+10);d.store("droped",c.dragging.getParent(c.dropSelecterString));d.store("lock",true);c.dragmoveInstance=new Drag.Move(d,{handle:this,droppables:c.getDropables.call(c),snap:0,onEnter:c.dargInject.bind(c),onStart:function(g){c.dragSign.setStyles($extend(c.dragging.getCis(),{visibility:"visible"}));if(a){a.start()}},onComplete:function(g){if(a){a.stop()}c.dobFx.start(c.dragging.getCis()).chain(function(){this.element.store("lock",false)})}});c.dragmoveInstance.start(f)},mouseup:function(f){c.dragmoveInstance.stop(f);c.dragmoveInstance.cancel(f);c.dragmoveInstance.detach();if(c.dragSign){c.dragSign.setStyle("visibility","hidden")}}})},initDrags:function(a){var c=this.drops;var b=this;a.each(function(e,d){b.fireEvent("onInitDrags",[e,a],this);e.addEvents({mouseenter:function(){var g=b.drag_operate_box;if(g.retrieve("lock")){return}$E(".dhb_title",g).setHTML(e.get("title")||"&nbsp;");g.setStyle("visibility","visible");g.store("drag",this);var f=e.getCis();f=$merge(f,{height:f.height.limit(24,1000)});b.dobFx.start(f)}});$ES("a",e).removeEvents().addEvent("click",function(f){f.stop()});$ES("form",e).removeEvents().addEvent("submit",function(f){f.stop()})})},initDrops:function(b){var a=this;b.each(function(c,d){a.checkEmptyDropPanel(c);a.fireEvent("onInitDrops",[c,b],this)})}});
var Widgets=new Class({Extends:DragDropPlus,initialize:function(b,c,a){this.parent(b,c,a);this.drags.each(function(d){if(d.getProperty("ishtml")){$E(".content-html",d).setHTML($E(".content-textarea",d).getValue())}})},inject:function(a,b){this.addWidget(this.curEl,a,b?b:this.theme)},newWidget:function(a){this.curDrop=a;this.curdialog=new parent.Dialog(top.SHOPADMINDIR+"index.php?ctl=content/pages&act=widgets",{width:800,height:500,title:"增加页面版块",modal:true,resizeable:true,onShow:function(b){this.dialog_body.id="dialogContent"}})},htmlarea:function(a){},ghostDrop:function(a,c){var a=a;var c=c;this.drag_operate_box.setStyle("visibility","hidden").store("lock",true);$("tempDropBox")?$("tempDropBox").empty().remove():"";parent._showWidgets_tip("在您需要放入版块的蓝色区域点击鼠标左键即可添加版块。点击鼠标右键则取消添加版块操作。");this.tempDropBox=new Element("div",{id:"tempDropBox"}).inject(document.body);try{this.drops.each(function(h,e){if(!h){return}var i=this;var g=h.getCis();if(g.height>5&&g.width>5){g.height-=5;g.width-=5}var d=new Element("div",{"class":"widgets_drop_ghost",styles:$merge(g,{opacity:0.3}),text:"["+(e+1)+"]",title:"点击此处，将["+a.name+"]版块添加到此区域"}).addEvents({mouseover:function(){this.addClass("widgets_drop_ghost_on")},mouseleave:function(){this.removeClass("widgets_drop_ghost_on")},click:function(){i.tempDropBox.empty();i.addWidget(h,a,c);i.drag_operate_box.store("lock",false);parent._hideWidgets_tip()}}).inject(i.tempDropBox)},this)}catch(b){alert(JSON.encode(b))}document.body.addEvent("contextmenu",function(d){d.stop();$("tempDropBox")?$("tempDropBox").empty().remove():"";parent._hideWidgets_tip();this.drag_operate_box.store("lock",false);document.body.removeEvent("contextmenu",arguments.callee)}.bind(this))},copyWidgets:function(a){},addWidget:function(a,b,d){var c={modal:true,title:"增加版块:["+b.label+"]",ajaksable:false};this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?ctl=system/template&act=doAddWidgets&p[0]="+b.name+"&p[1]="+d,c);this.curDrop=a},editWidget:function(a){var b={modal:true,title:"修改版块:["+a.label+"]",ajaksable:false};this.curWidget=$(a);if(a.get("ishtml")){return this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?ctl=content/pages&act=editHtml",$merge(b,{ajaksable:true,ajaxoptions:{method:"post",data:"htmls="+encodeURIComponent($E(".content-html",a).getHTML().clean().trim())},title:"编辑HTML"}))}this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?ctl=system/template&act=editWidgets&p[0]="+a.get("widgets_id")+"&p[1]="+a.get("widgets_theme"),b)},saveWidgets:function(){var c=[];var b=this.drops;var a={};b.each(function(g,d){var e=$ES(".shopWidgets_box",g);e.each(function(i){c.push(("widgets[{widgetsId}]={baseFile}:{baseSlot}:{baseId}").substitute({widgetsId:i.get("widgets_id"),baseFile:this.bf,baseSlot:this.bs,baseId:this.bi}));if(i.get("ishtml")){var h=$E(".content-html",i);c.push(("html[{widgetsId}]={htmls}").substitute({widgetsId:i.get("widgets_id"),htmls:encodeURIComponent(h.getHTML())}))}},{mce:this.mce,bf:g.get("base_file"),bs:g.get("base_slot"),bi:g.get("base_id")});a[g.get("base_file")]=1}.bind(this));for(f in a){c.push(("files[]={file}").substitute({file:f}))}new XHR({method:"post",onRequest:function(){top.MODALPANEL.show();top.$("loadMask").amongTo(top.window).show()},onSuccess:function(d){try{var d=Json.evaluate(d);for(dom in d){if($chk($(dom))&&$chk(d[dom])){$(dom).setProperty("widgets_id",d[dom])}}top.MessageBox.success("保存成功!")}catch(g){top.MessageBox.error("保存失败"+g.message)}finally{top.MODALPANEL.hide();top.$("loadMask").hide()}}}).send(top.SHOPADMINDIR+"index.php?ctl=system/template&act=widgetsSave",c.join("&"))}});window.addEvent("domready",function(){if(parent.$("loadMask")){parent.$("loadMask").hide().getElement(".loading_msg").set("text","正在加载...")}if(parent.MODALPANEL){parent.MODALPANEL.hide()}this.shopWidgets=new Widgets(".shopWidgets_box",".shopWidgets_panel",{onEdit:function(b,a){shopWidgets.editWidget(b)},onDelete:function(b){if(!confirm("确定删除此版块?")){return}var c=this.drag_operate_box;var d=this;c.setStyle("visibility","hidden").store("lock",true);var a=b.getParent();b.effect("opacity").start(0).chain(function(){b.remove();c.store("lock",false);d.checkEmptyDropPanel(a)})}})});
